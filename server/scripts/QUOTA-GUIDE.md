# SP-API 配额使用指南

## 🎯 快速开始

### 1. 分析配额使用情况（推荐首次使用）

运行配额分析脚本，查看系统预计的 API 调用频率：

```bash
# 方法1：使用 npm 脚本（推荐）
npm run analyze-quota

# 方法2：直接运行脚本
node scripts/analyze-quota-usage.js
```

**输出示例：**

```
✅ 状态: 配额使用率健康（<70%）
   系统运行良好，配额充足。

预计调用频率：
  US区域: 328 次/小时 (5.47 次/分钟)
  总计: 328 次/小时 (5.47 次/分钟)
```

### 2. 实时监控配额使用

实时监控当前配额使用情况：

```bash
# 方法1：使用 npm 脚本（推荐）
npm run monitor-quota

# 方法2：直接运行脚本
node scripts/monitor-quota-realtime.js
```

**输出特点：**

- 每 60 秒自动刷新
- 彩色进度条显示配额使用率
- 按 Ctrl+C 停止监控

## 📊 配额说明

### 当前配额限制

根据你的系统配置：

- **每分钟：60 次请求**
- **每小时：1,000 次请求**

这些限制在 `rateLimiter.js` 中配置，可以通过环境变量修改：

- `SP_API_RATE_LIMIT_PER_MINUTE`：每分钟限制（默认 60）
- `SP_API_RATE_LIMIT_PER_HOUR`：每小时限制（默认 1000）

### 实际使用情况

根据分析结果：

- **当前预计使用：5.47 次/分钟，328 次/小时**
- **使用率：分钟 9.1%，小时 32.8%**
- **状态：✅ 健康**

你的配额非常充足！

## 🔍 理解分析结果

### 配额使用率指标

- **< 70%**：✅ 健康 - 配额充足，系统运行良好
- **70-85%**：⚠️ 注意 - 配额使用率较高，建议监控
- **85-95%**：⚠️ 警告 - 需要优化，否则可能触发限流
- **> 95%**：❌ 危险 - 超过配额限制，系统将被限流

### 调用频率计算

系统会按照以下规则计算：

1. **US 区域**：按系统设置的监控间隔执行（默认每 30 分钟）

   - 每次检查所有 US 的 ASIN
   - 标准监控 + 竞品监控 = 双倍调用

2. **EU 区域**：按系统设置的监控间隔执行（默认每 60 分钟）

   - 每次检查所有 EU 的 ASIN
   - 标准监控 + 竞品监控 = 双倍调用

3. **计算公式**：
   ```
   US每小时调用 = ASIN数量 × (60/US间隔分钟) × 2个任务
   EU每小时调用 = ASIN数量 × (60/EU间隔分钟) × 2个任务
   总调用 = US调用 + EU调用
   ```

## 🛠️ 优化建议

### 如果配额使用率过高

#### 1. 启用分批处理（推荐）

如果预计调用频率超过配额的 70%，可以启用分批处理：

在 `.env` 文件中添加：

```env
MONITOR_BATCH_COUNT=2
```

这将把 ASIN 分散到 2 个批次检查，有效降低峰值调用频率。

**示例：**

- 未分批：每次检查所有 82 个 ASIN = 164 次/次（标准+竞品）
- 分批 2 批：每次检查 41 个 ASIN = 82 次/次
- 降低 50%的峰值调用

#### 2. 增加缓存时间

系统已实现缓存机制（默认 10 分钟），可以减少重复检查。如果 API 调用频繁，可以考虑：

- 增加缓存 TTL（需要修改代码）
- 确保缓存正常工作

#### 3. 调整检查频率

如果分批处理仍不够，可以在系统设置 → SP-API 配置 → 定时监控频率中调整：

- 增加 US 区域的检查间隔（例如从 30 分钟改为 60 分钟）
- 增加 EU 区域的检查间隔

#### 4. 申请更高配额

如果优化后仍不足，可以联系 Amazon 申请提高配额限制。

## 📈 监控建议

### 日常监控

1. **定期运行分析脚本**（每周一次）

   ```bash
   npm run analyze-quota
   ```

   特别是在添加大量 ASIN 后。

2. **实时监控**（需要时）
   ```bash
   npm run monitor-quota
   ```
   当系统出现限流错误时使用。

### 警告信号

以下情况需要关注：

1. **配额使用率 > 70%**

   - 开始监控配额使用情况
   - 考虑启用分批处理

2. **配额使用率 > 85%**

   - 立即优化
   - 检查是否有不必要的 API 调用

3. **出现 429 错误（限流）**
   - 检查配额使用情况
   - 启用分批处理或减少检查频率

## 🔧 故障排查

### 问题：分析脚本无法连接数据库

**解决方案：**

1. 检查 `.env` 文件中的数据库配置
2. 确认数据库服务正在运行
3. 检查数据库用户权限

### 问题：监控脚本显示配额为 0

**解决方案：**

1. 确认服务器正在运行
2. 检查限流器是否正确初始化
3. 查看服务器日志中的限流器初始化信息

### 问题：配额使用率异常高

**解决方案：**

1. 运行分析脚本查看预计使用情况
2. 检查是否有意外的 API 调用
3. 考虑启用分批处理

## 📝 当前状态总结

根据你的系统配置：

✅ **配额充足**

- 预计使用：5.47 次/分钟，328 次/小时
- 使用率：分钟 9.1%，小时 32.8%
- 状态：健康

💡 **建议**

- 当前配额非常充足，无需优化
- 可以继续添加更多 ASIN（在 700 个以下仍然安全）
- 定期监控配额使用情况

## 🔗 相关文件

- `scripts/analyze-quota-usage.js` - 配额分析脚本
- `scripts/monitor-quota-realtime.js` - 实时监控脚本
- `src/services/rateLimiter.js` - 限流器实现
- `src/services/schedulerService.js` - 调度配置
