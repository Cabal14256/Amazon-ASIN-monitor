# SP-API 配额管理脚本

这个目录包含用于分析和监控 SP-API 配额使用情况的实用脚本。

## 脚本列表

### 1. `analyze-quota-usage.js` - 配额使用分析

分析数据库中的 ASIN 数量，计算预计的 API 调用频率，评估配额是否充足。

**使用方法：**

```bash
cd server
node scripts/analyze-quota-usage.js
```

**功能：**
- 统计各区域（US/EU）的 ASIN 数量
- 计算预计的 API 调用频率（每分钟/每小时）
- 对比配额限制，评估使用率
- 提供优化建议（分批处理、缓存等）

**输出示例：**
```
============================================================
📊 SP-API 配额使用分析报告
============================================================

📈 数据统计：
US区域: 500 个ASIN, 50 个变体组
EU区域: 1000 个ASIN, 100 个变体组

📊 预计API调用频率：
US区域: 2,000 次/小时 (33.33 次/分钟)
EU区域: 2,000 次/小时 (33.33 次/分钟)
总计: 4,000 次/小时 (66.67 次/分钟)

⚖️  配额对比：
配额限制: 60 次/分钟, 1,000 次/小时
预计使用: 66.67 次/分钟, 4,000 次/小时

✅ 安全评估：
❌ 状态: 配额使用率过高（>95%）！
```

### 2. `monitor-quota-realtime.js` - 实时配额监控

实时监控限流器的配额使用情况，显示剩余令牌数和使用率。

**使用方法：**

```bash
cd server
node scripts/monitor-quota-realtime.js
```

**功能：**
- 实时显示 US 和 EU 区域的配额使用情况
- 显示分钟和小时配额的使用率
- 彩色进度条显示配额剩余情况
- 自动刷新（默认每60秒）

**环境变量：**
- `QUOTA_MONITOR_INTERVAL`: 监控刷新间隔（毫秒），默认 60000（60秒）

**输出示例：**
```
======================================================================
SP-API 配额实时监控
======================================================================
更新时间: 2024-01-01 12:00:00

US 区域
──────────────────────────────────────────────────────────────────────
分钟配额: 45/60 剩余 (使用率: 25.0%)
         [████████░░░░░░░░░░░░░░░░░░░░]
小时配额: 800/1,000 剩余 (使用率: 20.0%)
         [████████░░░░░░░░░░░░░░░░░░░░]
```

**停止监控：**
- 按 `Ctrl+C` 停止监控

## 使用场景

### 场景1：部署前评估
在部署系统前，运行分析脚本评估配额是否充足：
```bash
node scripts/analyze-quota-usage.js
```

### 场景2：运行时监控
在系统运行时，持续监控配额使用情况：
```bash
node scripts/monitor-quota-realtime.js
```

### 场景3：问题排查
当遇到限流错误时，使用监控脚本查看配额状态：
```bash
# 快速查看一次
node scripts/monitor-quota-realtime.js
# 然后按 Ctrl+C 停止
```

## 配额优化建议

根据分析结果，可以采取以下优化措施：

1. **启用分批处理**
   - 在 `.env` 文件中设置 `MONITOR_BATCH_COUNT=2` 或更高
   - 将大量 ASIN 分散到多个批次检查

2. **增加缓存时间**
   - 系统已实现缓存机制，默认 10 分钟
   - 可以减少重复检查的频率

3. **调整检查频率**
   - 修改 `schedulerService.js` 中的 cron 表达式
   - 减少每小时或每天的检查次数

4. **申请更高配额**
   - 如果优化后仍不足，联系 Amazon 申请提高配额限制

## 注意事项

1. **数据库连接**
   - 确保 `.env` 文件中配置了正确的数据库连接信息
   - 分析脚本需要访问数据库

2. **限流器状态**
   - 监控脚本需要服务器正在运行
   - 限流器必须在服务器启动时已初始化

3. **配额限制**
   - 配额限制从环境变量 `SP_API_RATE_LIMIT_PER_MINUTE` 和 `SP_API_RATE_LIMIT_PER_HOUR` 读取
   - 如果未设置，使用默认值：60/分钟，1000/小时

## 故障排查

### 问题1：分析脚本无法连接数据库
- 检查 `.env` 文件中的数据库配置
- 确认数据库服务正在运行
- 检查数据库用户权限

### 问题2：监控脚本显示配额为 0
- 确认服务器正在运行
- 检查限流器是否正确初始化
- 查看服务器日志中的限流器初始化信息

### 问题3：配额使用率异常高
- 运行分析脚本查看预计使用情况
- 检查是否有意外的 API 调用
- 考虑启用分批处理或减少检查频率

