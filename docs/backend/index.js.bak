require('dotenv').config();
const express = require('express');
const cron = require('node-cron');
const SellingPartnerAPI = require('amazon-sp-api');
const https = require('https');

// 强制 Node.js 使用 UTF-8 环境
process.env.LC_ALL = 'en_US.UTF-8';
process.env.LANG = 'en_US.UTF-8';
process.env.NODE_ENV = 'production';

const app = express();
const port = process.env.PORT || 3000;

// 初始化 SellingPartnerAPI
const sp = new SellingPartnerAPI({
  region: 'na',
  refresh_token: process.env.SP_API_REFRESH_TOKEN,
  credentials: {
    SELLING_PARTNER_APP_CLIENT_ID: process.env.SP_API_CLIENT_ID,
    SELLING_PARTNER_APP_CLIENT_SECRET: process.env.SP_API_CLIENT_SECRET,
    AWS_ACCESS_KEY_ID: process.env.AWS_ACCESS_KEY_ID,
    AWS_SECRET_ACCESS_KEY: process.env.AWS_SECRET_ACCESS_KEY,
    role_arn: process.env.SP_API_ROLE_ARN
  },
  auto_request_tokens: true,
  auto_request_threshold: 60,
  rate_limit: {
    retry: true,
    retry_count: 3,
    retry_delay: 2000
  }
});

app.get('/', (req, res) => {
  res.send('Amazon ASIN Monitor is running');
});

// 获取变体数据的函数（打印原始响应）
const getVariantData = async (asin) => {
  try {
    console.log(`Fetching data for ASIN: ${asin}`);
    const result = await sp.callAPI({
      operation: 'getCatalogItem',
      endpoint: 'catalogItems',
      path: {
        asin: asin
      },
      query: {
        marketplaceIds: ['ATVPDKIKX0DER'],
        includedData: ['variations']
      }
    });
    
    // 打印原始API响应（关键）
    console.log('[Raw API Response]', JSON.stringify(result, null, 2));
    
    const variations = result.variations?.[0]?.asins || [];
    return variations;
  } catch (error) {
    console.error('Failed to call SP-API:', error);
    if (error.response) {
      console.error('[API Error Response]', error.response.data);
    }
    return [];
  }
};

// 确保字符串是有效的 UTF-8
const ensureUtf8 = (str) => {
  if (typeof str !== 'string') {
    str = String(str);
  }
  return Buffer.from(str, 'utf-8').toString('utf-8');
};

// 飞书消息发送函数
const sendToFeishu = async (message) => {
  const feishuWebhookUrl = process.env.FEISHU_WEBHOOK_URL;
  if (!feishuWebhookUrl) {
    console.error('Feishu Webhook URL not set');
    return;
  }

  const safeMessage = ensureUtf8(message);
  const url = new URL(feishuWebhookUrl);
  const requestBody = {
    msg_type: 'text',
    content: {
      text: safeMessage
    }
  };
  const jsonBody = JSON.stringify(requestBody);
  const utf8Body = Buffer.from(jsonBody, 'utf-8');

  console.log('[Final Sent Content]', jsonBody);
  console.log('[Content Bytes]', utf8Body.length);

  const options = {
    hostname: url.hostname,
    port: url.port || 443,
    path: url.pathname,
    method: 'POST',
    headers: {
      'Content-Type': 'application/json; charset=utf-8',
      'Content-Length': utf8Body.length
    }
  };

  return new Promise((resolve, reject) => {
    const req = https.request(options, (res) => {
      let responseData = '';
      res.on('data', (chunk) => {
        responseData += chunk.toString('utf-8');
      });
      res.on('end', () => {
        console.log('Feishu Response:', res.statusCode, responseData);
        resolve({ status: res.statusCode, data: responseData });
      });
    });

    req.on('error', (error) => {
      console.error('Feishu Request Error:', error);
      reject(error);
    });

    req.write(utf8Body);
    req.end();
  });
};

// 发送测试消息
const sendTestMessage = async () => {
  const testMessage = "This is a UTF-8 test message";
  console.log('[Test Message]', testMessage);
  console.log('[Test Message Bytes]', Buffer.from(testMessage, 'utf-8').toString('hex'));
  await sendToFeishu(testMessage);
};

// 监控函数
const monitorAsin = async (asin) => {
  console.log(`Starting ASIN check: ${asin}`);
  const variations = await getVariantData(asin);
  const hasVariations = variations.length > 0;

  console.log(`ASIN: ${asin} | Variations: ${hasVariations ? 'Yes' : 'No'} | Count: ${variations.length}`);

  let message;
  if (hasVariations) {
    message = `ASIN ${asin} has variations. Variation count: ${variations.length}. Details: ${variations.join(', ')}`;
  } else {
    message = `Warning: ASIN ${asin} has no variations.`;
  }
  
  message = ensureUtf8(message);
  await sendToFeishu(message);
  return variations;
};

// 监控多个ASIN的函数
const monitorAsins = async () => {
  const checkAsins = ['B0F5W9M8BP', 'B0DZP3FXVW', 'B0DZP2S71K'];
  const results = {};

  for (const asin of checkAsins) {
    const variations = await monitorAsin(asin);
    results[asin] = {
      hasVariations: variations.length > 0,
      variationCount: variations.length,
      variations: variations
    };
  }

  return results;
};

// 启动时发送测试消息
console.log('Sending test message...');
sendTestMessage();

// 设置定时任务
cron.schedule('0 * * * *', () => {
  console.log('\nScheduled task started...');
  monitorAsins().then(results => {
    console.log('Monitoring results:', results);
  }).catch(error => {
    console.error('Scheduled task failed:', error);
  });
});

// 立即执行一次监控
console.log('Immediate monitoring started...');
monitorAsins().then(results => {
  console.log('First monitoring results:', results);
}).catch(console.error);

// 启动 Express 服务
app.listen(port, '0.0.0.0', () => {
  console.log(`Server running on port ${port}`);
});