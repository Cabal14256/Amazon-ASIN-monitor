# ASIN 变体查询系统 - 架构概览

## 项目概述

ASIN 变体监控系统是一个用于监控 Amazon 商品变体状态的自动化系统。系统通过调用 Amazon SP-API（Selling Partner API）来查询 ASIN 是否有变体关系，并记录监控历史，支持定时监控和手动查询。

## 整体架构

### 系统分层

```
┌─────────────────────────────────────────────────────────┐
│                     前端层 (Vue.js)                      │
│  - 变体组管理  - 历史查询  - 数据分析  - 批量操作        │
└────────────────────┬────────────────────────────────────┘
                     │ HTTP API
┌────────────────────▼────────────────────────────────────┐
│                    API路由层 (Express)                  │
│  /api/variant-groups  /api/history  /api/analytics      │
└────────────────────┬────────────────────────────────────┘
                     │
┌────────────────────▼────────────────────────────────────┐
│                  业务逻辑层 (Services)                    │
│  - variantMonitor.js  (核心变体查询)                     │
│  - writeSnapshot.js   (快照存储)                         │
│  - competitorMonitor.js (竞品监控)                       │
└────────────────────┬────────────────────────────────────┘
                     │
┌────────────────────▼────────────────────────────────────┐
│                  工具层 (Utils)                          │
│  - spapi.js       (SP-API客户端封装)                      │
│  - spClient.js    (Legacy SP-API + HTML兜底)             │
│  - regionCreds.js (多区域凭据管理)                       │
│  - db.js/db2.js   (数据库连接)                           │
└────────────────────┬────────────────────────────────────┘
                     │
┌────────────────────▼────────────────────────────────────┐
│                  数据层                                   │
│  - MySQL数据库 (变体组、ASIN、历史记录)                  │
│  - Amazon SP-API (商品信息查询)                          │
└─────────────────────────────────────────────────────────┘
```

## 核心模块说明

### 1. 路由模块 (Routes)

#### `backend/routes/variantGroup.js`

- 变体组管理：创建、删除、查询变体组
- ASIN 管理：添加、删除 ASIN 到变体组
- 批量导入：支持 Excel 批量导入
- 飞书通知配置

#### `backend/routes/history.js`

- 历史记录查询：分页查询变体状态历史
- 批量查询接口：手动触发变体查询
- 数据导出：支持 Excel 导出

### 2. 服务模块 (Services)

#### `backend/services/variantMonitor.js` ⭐ 核心模块

这是整个系统的核心，负责：

- **getVariantData()**: 查询 ASIN 的变体信息
- **doMonitorAndNotify()**: 执行监控并发送通知
- **saveHistoryFromMonitor()**: 保存监控历史
- **registerMonitorJobs()**: 注册定时任务

关键函数位置：

```86:180:backend/services/variantMonitor.js
async function getVariantData(asin, marketKey) {
  const asinNorm = String(asin || '').trim().toUpperCase();

  let variations = [];
  let brotherAsins = [];
  let hasVariation = false;
  let brand = null;
  let parentAsin = null;

  // 1) 官方 SP-API 调 catalogItems v2022-04-01
  try {
    const sp = makeSp(marketKey);                                // 按 US/EU 取凭据
    const marketplaceId = MARKETPLACE[marketKey] || MARKETPLACE.US;

    const result = await getCatalogItem(sp, asinNorm, marketplaceId);

    const relationships = Array.isArray(result?.relationships) ? result.relationships : [];
    const variationsField = Array.isArray(result?.variations) ? result.variations : [];
    variations = variationsField.length ? variationsField : relationships;

    // 旧结构：variation.asins 里是兄弟 asin
    const asinsList = Array.isArray(variations?.[0]?.asins) ? variations[0].asins : [];
    brotherAsins = asinsList
      .map(x => String(x || '').toUpperCase())
      .filter(a => a && a !== asinNorm);
    hasVariation = brotherAsins.length > 0;

    // 品牌：优先 summaries.brandName，其次 attributes.brand
    brand =
      result?.summaries?.[0]?.brandName ??
      (Array.isArray(result?.attributes?.brand)
        ? result.attributes.brand[0]
        : result?.attributes?.brand) ??
      null;

    // 旧结构：summaries.parentAsin
    parentAsin = result?.summaries?.[0]?.parentAsin || null;

    // 旧结构：relationships[*].relationships[*].type === 'PARENT' && asin
    if (!parentAsin && Array.isArray(result?.relationships)) {
      for (const rel of result.relationships) {
        const arr = Array.isArray(rel?.relationships) ? rel.relationships : [];
        const p = arr.find(x => String(x?.type).toUpperCase() === 'PARENT' && x?.asin);
        if (p?.asin) {
          parentAsin = p.asin;
          break;
        }
      }
    }

    // ⭐ 新结构：variations[*].relationships[*].parentAsins[0]
    if (!parentAsin && Array.isArray(variations)) {
      for (const v of variations) {
        const rels = Array.isArray(v?.relationships) ? v.relationships : [];
        for (const r of rels) {
          if (Array.isArray(r?.parentAsins) && r.parentAsins.length) {
            parentAsin = r.parentAsins[0];
            break;
          }
        }
        if (parentAsin) break;
      }
    }

  } catch (e) {
    console.error(`❌ 获取 ASIN ${asinNorm} @ ${marketKey} 失败:`, e?.message || e);
  }

  // 2) 如果官方 SP-API 还没给出父体，再用 legacySpClient 兜底
  if (!parentAsin && legacySpClient && typeof legacySpClient.getParentAndStatus === 'function') {
    try {
      const r = await legacySpClient.getParentAndStatus(asinNorm, marketKey);
      const raw = r?.parent_asin ?? r?.parentAsin ?? r?.parent ?? null;
      if (raw) parentAsin = String(raw).toUpperCase();
      if (typeof r?.is_broken === 'number') {
        hasVariation = r.is_broken === 0;
      }
    } catch (e) {
      console.warn('[VARIANT-MONITOR] legacy spClient failed:', e?.message || e);
    }
  }

  // 3) 只要拿到父体，就认为存在变体（哪怕没有兄弟 asins）
  if (parentAsin && !hasVariation) {
    hasVariation = true;
  }

  return {
    variations,
    brotherAsins,
    hasVariation,
    brand: brand ?? '未知',
    parentAsin: parentAsin ? String(parentAsin).toUpperCase() : null,
  };
}
```

#### `backend/services/writeSnapshot.js`

统一的数据快照写入服务：

- 写入监控快照表 (`monitor_snapshots`)
- 可选写入历史表 (`variant_history`)
- 支持多数据库连接（db/db2/db3）

### 3. 工具模块 (Utils)

#### `backend/utils/spapi.js`

SP-API 客户端封装：

- **makeSp()**: 根据国家创建 SP-API 客户端
- **getCatalogItem()**: 调用 Catalog Items API 获取商品信息
- 支持 US 和 EU 两个区域的凭据管理

#### `backend/utils/spClient.js`

Legacy SP-API 客户端和 HTML 兜底：

- **getParentAndStatus()**: 通过多种方式获取父体 ASIN
- **scrapeParentAsin()**: 从 HTML 页面抓取父体 ASIN

#### `backend/utils/regionCreds.js`

多区域凭据管理：

- **pickRegion()**: 根据国家选择区域（US/EU）
- **pickCredsByRegion()**: 获取对应区域的凭据

## 数据流向

### 定时监控流程

```
1. 定时任务触发 (cron)
   ↓
2. loadAsinsFromDB() - 从数据库加载ASIN列表
   ↓
3. doMonitorAndNotify() - 并发查询（限制5个并发）
   ↓
4. getVariantData() - 调用SP-API查询变体信息
   ↓
5. saveHistoryFromMonitor() - 保存快照和历史
   ↓
6. sendToFeishu() - 发送飞书通知（如有异常）
```

### 手动查询流程

```
1. 前端调用 POST /api/history/query
   ↓
2. 路由处理 (routes/history.js)
   ↓
3. 循环调用 getVariantData() 查询每个ASIN
   ↓
4. 写入 variant_history 表
   ↓
5. 返回批次号给前端
```

## 数据库设计

### 核心表结构

#### `variant_groups` - 变体组表

- `id`: 主键
- `name`: 组名
- `country`: 国家代码（US/UK/DE 等）
- `feishu_enabled`: 是否启用飞书通知

#### `asins` - ASIN 表

- `id`: 主键
- `asin`: ASIN 码
- `variant_id`: 关联变体组 ID
- `site`: 站点信息
- `brand`: 品牌（手工维护）
- `amazon_brand`: 亚马逊品牌（从 API 获取）
- `is_broken`: 是否异常（0=正常，1=异常）
- `chain_type`: 主链/副评（1=主链，2=副评）

#### `variant_history` - 历史记录表

- `country`: 国家
- `asin`: ASIN 码
- `event_time`: 事件时间
- `status`: 状态（恢复/异常）
- `parent_title`: 父体 ASIN
- `chain_type`: 主链/副评
- `batch`: 批次号

#### `monitor_snapshots` - 监控快照表（asin_analytics 库）

- 存储每次监控的快照数据
- 包含与 variant_history 类似的字段

## 定时任务调度

定时任务通过 `backend/jobs/scheduler.js` 统一管理：

```81:87:backend/jobs/scheduler.js
function initSchedulers() {
  console.log('⏰ 定时任务调度器启动...');
  // 你原来的：普通监控
  registerMonitorJobs();
  // 新增：竞品监控
  registerCompCron();
}
```

### 变体监控任务

- **每小时第 30 分钟**: 执行美国 ASIN 监控
- **整点**: 执行美国+欧洲 ASIN 监控
- **启动时**: 立即执行一次美国监控

任务注册位置：

```414:432:backend/services/variantMonitor.js
function registerMonitorJobs() {
  cron.schedule('30 * * * *', async () => {
    console.log('⏰ 每小时第 30 分钟跑美国');
    await monitorUSAsins();
  }, { timezone: 'Asia/Shanghai' });

  cron.schedule('0 * * * *', async () => {
    console.log('⏰ 整点，先美国后欧洲');
    await monitorUSAsins();
    await monitorEUAsins();
  }, { timezone: 'Asia/Shanghai' });

  (async () => {
    console.log('🚀 启动后立即跑一次美国/欧洲监控...');
    await monitorUSAsins();
    // 如需启动时也跑欧洲，解除下一行注释：
    // await monitorEUAsins();
  })();
}
```

## 关键设计决策

### 1. 多层兜底策略

系统采用三层兜底机制确保查询成功率：

1. **SP-API 官方接口** (主要方式)
2. **Legacy SP-API 客户端** (第一层兜底)
3. **HTML 页面抓取** (最后兜底)

### 2. 并发控制

使用 `p-limit` 库限制并发数为 5，避免 API 限流：

```291:291:backend/services/variantMonitor.js
  const limit = pLimit(5);
```

### 3. 多区域支持

系统支持 US 和 EU 两个区域，通过 `regionCreds.js` 管理不同区域的凭据。

### 4. 数据分离

- 快照数据存储在 `asin_analytics.monitor_snapshots`
- 历史数据存储在 `variant_history`
- 支持通过环境变量控制是否自动写入历史

## 总结

ASIN 变体查询系统的核心在于 `getVariantData()` 函数，它通过调用 Amazon SP-API 获取商品信息，然后从多个可能的路径中提取变体关系。系统设计考虑了容错性、并发控制和多区域支持，确保监控任务的稳定执行。
